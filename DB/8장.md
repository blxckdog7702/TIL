# 8장 데이터베이스 운용 기술의 급소  

## 8.1 데이터베이스 운용의 어려움을 알자  

- 운영 노하우는 운영을 통해서 얻을 수 있기 때문에 값지다.
- 문제를 빠르게 해결하는 것보다는 문제를 조기에 인식하는게 중요하다.
- 문제를 조기에 인지하기 위해서는 모니터링과 같은 구조가 중요하다.

## 8.2 문제 예방  

### 잘 알고 있는 기술을 사용  

- 문제를 방지하는데 중요한 것은 자신과 팀이 잘 알고 있는 기술을 사용해야 한다는 것.
- 어느 부분이 위험한지 예측 가능하고, 문제가 발생해도 빠른 해결이 가능하다.

### 입증된 기술을 사용  

- 실 환경에서 충분히 검증된 제품을 사용하는 것이 좋다. 오랫동안 사용되면서 버그가 수정되어 품질이 좋아짐.
- 일반적으로 새로운 기술이 더 문제가 많다.
- 1년 뒤에 또 다른 새로운 기술이 나오면 또 갈아탈 것인가?
- 실행 중인 서비스에서 새로운 제품으로의 대체는 쉽지 않다.
- 서비스를 멈추지 않도록 하면서 이식을 고려해 나가지 않으면 안되기 때문이다.
- 중요한 것은 새로운 기술과 기존 기술의 차이를 파악하는 것이다.

### 아키텍쳐를 복잡하게 하지 않기  

- 시스템 구성을 최대한 단순하게 하는 것이 중요하다.
- 운영은 여러 사람이 참여하기 때문에 다른 사람이 빠르게 파악할 수 있도록 최대한 단순하게 구조를 가져가는 것이 좋다.
- 그래서 널리 보급된 제품을 써야 대체 인력을 구하기도 쉽다.

### 실험대가 되는 환경도 제공하기  

- 그래도 부담이 적은 선에서 새로운 기술을 테스트해보는 것도 기술 발전을 위해서 필요하다.
- 근데 중요한 프로젝트에서 자꾸 실험을 하려하면 그렇게 하지 못하도록 설득하라.
- 그것이 안된다면 그 프로젝트로부터 도망쳐라!

## 8.3 문제 인지  

- 문제를 완전히 막는 것은 불가능하기 때문에 어떻게 문제를 빨리 인식해서 고칠지를 고민해봐야 한다.  
- 컴퓨터가 다운을 자동으로 감지하고, 그것을 운영 담당자에게 조치할 수 있도록 알리는게 중요하다.
- 또한, 긴급한 상황이 오기 전에 (ERROR), 그 전 단계에서 경고(WARN)를 해서 이슈 발생 전에 미리 대응할 수 있도록 하는 것이 중요하다.  

### 모니터링해야 할 항목  

#### 응답 시간  

- 웹 서버의 액세스 로그를 분석하거나, 테스트 HTTP 클라이언트에서 접속을 시도하여 측정할 수 있다.
- 대부분 몇 ms ~ 수십 ms 정도에 머무르는데, 극히 일부가 3~5초 정도로 되는 경향을 볼 수 있다.
- 이는 간혹 TCP 연결을 하지 못하고 실패했을 경우, 재시도 전 대기하는 시간을 포함하기 때문이다.
- 대부분(99%) 요청의 응답 시간이 정상이면 괜찮다.

#### CPU 사용률  

- 디스크I/O(%iowait)
- 시스템 공간 사용률(%system)
- 사용자 공간 사용률(%user)

**디스크I/O**  
데이터베이스는 처리하는 데이터 양이 큰 것도 있어서 %iowait가 문제가 되는 경우가 많다. 디스크I/O가 병목현상이 발생하는 경우 이 값이 크게 튀어오른다. 디스크 I/O 대기가 심각한 처리는 응답 시간도 악화된다.  

**시스템 공간 사용률**  
OS 내의 처리(시스템 콜)에서 사용하는 것이기 때문에 일반적으로 병목현상이 발생할 수 없다. 하지만 스왑이 높은 빈도로 발생하는 경우나 네트워크 쪽에서 문제가 발생하는 경우는 이 값이 튈 수 있다.  
네트워크 전송 상태도 감시해야하는데, 전송량이 처리 능력의 한계에 도달하면 더는 처리할 수 없게 되고 그러면 요청이 계속 쌓이게 된다. 네트워크 부하 상황은 mpstat로 %irq %soft를 살펴보면 된다.  

**사용자 공간 사용률**  
이 값은 I/O 병목현상이 나타나기 쉬운 DB 서버에서는 문제가 되는 일은 적다. 이 값이 크게 나오는 경우는 작은 테이블에 대해서 이루어지는 테이블 스캔을 연발하는 등 비정상적인 상황이 발생하는 경우가 높다.  

#### 동시접속 수 및 스톨  

모든 클라이언트가 일정 시간 동안 아무것도 할 수 없는 경우가 있는데, 여러 스레드가 데이터베이스 내부의 크리티컬 섹션에 일제히 접근하려고 할 때 나머지 스레드는 기다려야 한다.  
부하가 한계치를 초과하면 주된 처리를 멈추고 강제로 복구 처리를 하는 경우가 있다. 갱신량이 너무 많아서 REDO 로그 파일 쓰기 속도가 못따라가면 update를 블록한 상태에서 REDO 로그 파일로 쓰기를 우선적으로 실시한다.  
이런 식으로 많은 클라이언트가 작업을 기다리게 돼서 전체적으로 시스템이 일시적으로 멈춘 것처럼 보이는 것을 **스톨**이라고 한다.  

스톨을 감지하는데 중요한 것은 감시 시간 간격이다. 스톨은 많은 경우 1초 전후 상황에서 밖에 발생하지 않기 때문에, 짧은 간격으로 모니터링해야 발견할 수 있다.  
스톨이 발생하는 주 원인은 RDBMS를 잘못 구현한 경우가 대부분이다. 오픈 소스 제품은 스톨이 발생한 순간에 gdb 같은 디버거를 사용하여 프로세스의 스택 트레이스를 얻어서 원인 분석이 가능하다.  

#### 초당 SQL 실행 횟수  

- 갑자기 SQL 요청이 늘어나면 이상하다.
- 캐시가 죽었을 수도 있고, RDBMS에 버그가 있을 수도 있다.

#### 접속 여부 및 데이터베이스 내부 상태  

- DB에 접속할 수 있는지 여부 확인
- 복제 구성의 동기화가 지연되고 있지 않은지에 대해서 감시

#### 하드웨어 장애  

- 기계는 다운되지 않았으나 부분적으로 결함이 있는 상태가 많이 감지됨.
- 디스크나, 메모리 등 손상된 시점에서 바로 알 수 있도록 시스템 구성
- 디스크 장애 시, 핫스왑에 의해 디스크를 교체하고 RAID를 재구성 할 수 있다.  

그 외 하드웨어 감시 항목  

- RAID 컨트롤러의 배터리 소멸 상황
- 디스크의 고장 상태나 블록 오류
- SSD의 블록 고장 상황
- 네트워크 카드의 고장 상황

#### 빈 공간  

- 디스크 빈 공간과 테이블 공간(테이블 데이터 저장 장소)의 빈 영역이 제로가 되면 데이터를 저장할 수 없다. 갱신 처리가 될 수 없으므로 대부분의 요청은 실패하게 된다.  
- 빈 공간은 OS에서 본 빈 공간(df하면 되는 거) 과, 데이터베이스에서 본 테이블의 빈 영역 (RDBMS 제품에 따라 다름). 둘 다 모니터링이 필요함
- OS 빈 공간은 백업 등에서 영향을 받고 있으며, 후자는 평소의 처리에서 영향을 받는다.

## 8.4 문제 해결  

### 성능 문제에 대한 대처  

#### 애플리케이션 수정  

- 상당수 성능 문제는 앱 문제인 경우가 많아서 앱을 수정하면 되는 경우가 많다.
  
#### 웹 서버 증설  

- 웹 서버가 병목이 된 경우에 유효한 방법
- 웹 서버는 데이터를 가지지 않기 때문에 구축이 DB에 비해서는 편하다. (복원 안해도 되니까)

#### 캐시 서버 증설  

- 캐시가 죽거나 캐시 용량이 부족해서 DB로 직접 오는 요청 수가 엄청 늘어난 경우이다.
- DB 보다는 캐시를 늘려서 해결 할 수 있는 문제가 많다.

#### 슬레이브 서버의 증설  

- 참조 처리가 많은 경우엔 마스터로 참조되고 있는 트래픽을 슬레이브 서버로 돌리거나, 슬레이브를 추가하여 문제를 해결할 수 있다.

#### 보다 스펙이 높은 서버로의 마이그레이션 및 서버 분할  

- 마스터가 트래픽을 견디지 못한다면 마스터를 스케일 업 한다.
- 데이터 자체를 분할하여 여러 서버에 분할하는 등 대책이 필요

### 돌연사에 대한 대처  

#### 일상적인 장애  

- 하드웨어 장애로 다운되는 등, 확률상 발생할 것으로 예상되는 유형의 장애
- 가능한 한 자동으로 복구하는 것이 중요

#### 비정형적인 장애  

- 설정 파일 작성 실수 등으로 나타나는 장애이다.
- 서비스를 시작하면서 앱이 죽는다던지의 이유로 장애를 파악할 수 있는건 운이 좋은 경우이다.
- 운이 나쁜 경우엔 잘 돌다가 오래 지나면 갑자기 픽하고 죽는다. 메모리 때문에
- 특정 데이터에비스만 문자 인코딩을 다르게 해서 복구를 못한 이슈가 있었다.
