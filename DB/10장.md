# 10장 MySQL의 소스 코드를 추적해보자  

## 10.1 소스 코드를 아는 것이 의미가 있을까?  

소스 코드를 알고 있으면 다음과 같은 경우에 유리하다.  

- 장애가 발생했을 때 원인을 찾을 수 있다.
- 자신이 직접 버그 수정을 할 수 있다.
- 자신에게 필요한 기능을 구현할 수 있다.

## 10.2 소스 코드의 구조를 보자  

10.1장에 나온 MySQL 소스코드 디렉토리 구조 중 중요한 것만 설명했다고 한다. 책에 있는 내용을 문서로 옮기지는 않겠다.  

## 10.3 소스 코드를 분석해 보자  

정적 분석과 동적 분석 두 가지 방법을 결합하여 소스 코드 분석을 소개하고 있다.  

### 정적 분석 방법  

grep 같은 텍스트 검색을 통해 그 주변을 검색하는 방법. 키워드를 알고 있을 때 할 수 있는 방법이다.  
책에서는 MySQL 상태 변수 `Aborted_connects` 로 소스 코드에서 검색해서 살펴보고 있다.  

### 동적 분석 방법  

MySQL을 디버깅해서 찾는 방법이다. gbd나 IDE를 사용한다. 그리고 사전에 소스 코드를 빌드해 둘 필요가 있기 때문에 정적 분석보다 시간이 걸린다. 하지만 브레이크 포인트도 걸 수 있어서 편리하다.  
UNIX/LINUX 계열에선 소스 코드로부터 빌드하기 위해서는 configure(cmake), make에 의해 빌드를 실행한 후 make install로 설치하는 3단계를 거친다.  

#### configure, cmake  

어떤 스토리지 엔진을 인스톨 할 것인가, 기본 캐릭터 셋을 정하는 등 주변 환경 설정을 한다.  
각종 환경 설정을 한 후에 Makefile을 만든다. 이 Makefile은 `make`에 의해 빌드되고, `make install`로 설치하게 된다.  
MySQL 5.5 부터는 cmake를 사용한다. configure는 window에서 호환성에 문제가 있으므로 cmake가 더 좋다.  

소스코드를 cmake로 빌드할 때 MySQL 빌드 바이너리와 같은 옵션으로 빌드하고 싶다면, `docs/INFO_BIN`을 참조하면 된다.  

#### make, make install  

MySQL 본체의 빌드는 make에 의해서 한다. make가 오류 없이 성공적으로 완료되면 make install을 실행한다.  
인스톨 이후에는 `mysql_install_db` 에 의해 설치가 된다.  

#### 디버그 기동  

gdb에서 mysqld를 기동하여 브레이크 포인트를 설정하고 my.cnf를 읽어들이게 함으로써 gdb로부터 디버깅이 가능하다.  

## 10.4 MySQL의 설계 사상을 알아보자  

### 플러그인화를 강력히 추진하고 있다  

### 외부 라이브러리에는 최대한 의존하지 않는다  

C++의 STL 같은 유명한 라이브러리들을 사용하지 않는다. 품질의 일정화와 플랫폼 의존성을 줄이기 위함이다. 라이브러리의 버그에 의해 제품 성능에 영향을 끼치는 경우를 없게 하기 위함이다. 이런 경우 서포트하는 측에서 매우 힘들기 때문에 유틸리티들을 전부 자체에서 보유하는 정책을 사용하고 있다. OS 의존 명령은 `my_xx`라는 래퍼 함수에서 제공하고 있다. 이 래퍼 함수에서 플랫폼에 맞는 시스템 콜을 해주겠지  

### 디버깅 기능  

C/C++은 저수준 프로그래밍 언어라 메모리 확보/해제, mutex lock 확보/해제 등을 직접 해야한다. 그래서 메모리 부정 액세스에 의한 영역 파괴나 크래쉬, mutex의 이중 확보에 의한 교착 상태 문제가 자주 발생한다. 이런 문제를 최대한 방지하기 위해서 MySQL에서는 디버그판에 대해 malloc/free/pthrea_* 같은 일부 함수에 대한 래퍼를 제공하여 이중 잠금이나 부정 액세스가 이루어지면 중단되도록 하고 있다. 또한 주요 함수가 호출되었을 때 함수 이름과 대표 인수 값을 추적하는 기능도 갖추고 있다.  
물론 이런 기능들은 성능 저해 요인이 되므로 릴리즈 버전에서는 기능이 무효로 되어 있다.  

### 엔디안 프리  

리틀 엔디안으로 설정되어 있다.  

### 함수 포인터, 서브 클래스를 많이 사용하여 범용성을 높이기  

레코드를 읽을 때, 쿼리에 따라 세부적인 검색 과정은 조금씩 다를 수 있으나 전체적인 검색 과정은 동일하다. 그래서 재사용이 가능한 부분을 C++의 서브 클래스나 C의 함수 포인터를 이용해서 처리한다는 이야기이다.  

### 플러그인 개발이란 무엇인가?  

MySQL에서는 스토리지 엔진 및 사용자 정의 함수, 통계 데이터베이스, 전체 텍스트 검색 기능의 일부, 복제 기능의 일부에 있어서 MySQL 본체를 직접 변경하는 대신 플러그인을 개발하여 인스톨하는 방식이 가능하도록 되어 있다. 플러그인은 공유 라이브러리(\*.so, \*.dll)로서 INSTALL PLUGIN은 MySQL 명령으로 설치할 수 있다. 표준 바이너리에 인스톨하는 것도 가능하다.  
플러그인 개발용 인터페이스가 공개되어 있어서 그 인터페이스에 맞게만 개발하면 된다. 오픈 소스 특성 상 본체 코드를 바꾸는 것 보다는 플러그인을 바꾸는게 기여에도 쉽고, 변경 사항을 적용하기도 쉽다.  

## 10.5 소스 해킹 사례 연구  

오픈 소스를 연구하려면 소스 코드를 보는 목적을 갖고 보는 것이 좋다.  

### 코어 파일에서 문제 부분 특정하기  

my.cnf에 매개변수 core-file을 붙여두면 크래시 시에 코어 파일이 생성된다. 그것을 gdb로 읽어들이면 어디서 크래시가 났는지 파악이 가능하다.  

#### 버그의 원인 파악하기  

원인을 파악하면 어플리케이션 개발자는 문제가 있는 로직을 회피하도록 할 수 있다.  

#### MySQL의 크래쉬 버그  

gdb를 이용하면 문제가 발생한 라인을 찾을 수 있다. 라인을 표시하려면 mysqld가 디버그 심볼이 붙어있어야 하는데 5.0 부터 표준 바이너리 빌드 옵션에 -g를 붙이게 되어있다.  
성능 저하는 거의 없다. CPU 병목 현상이 생기는 경우에 성능이 이슈가 되는데, 보통은 디스크I/O가 병목이기 때문에 문제 될 일은 거의 없다.  

### 스택 트레이스로부터 문제 파악하기  

MySQL에서는 간단한 SQL문도 실행 과정에서 몇가지 mutex의 lock/unlock을 실행한다. mutex 경쟁이 많아지게되면 전체 처리량이 떨어지게 된다. 해당 상황에서는 10초씩 걸리기 때문에 글로벌한 mutex를 확보한 상황에서 어떤 리소스 (네트워크I/O) 에 대한 액세스를 처리했으나 무엇인가 잘못되어 모든 스레드가 블록된 것이라고 예상  
이를 확인하려면 문제 발생 시간대의 mysqld 프로세스 내의 모든 스레드 스택 덤프를 반복해서 취하면 된다. Linux에서는 pstack 명령어를 사용하면 프로세스 안의 모든 스레드의 스택 트레이스를 취할 수 있다. 그런데 줄 번호를 표시해주지 않기 때문에 gdb를 쓰는게 더 간편하다. gdb로 프레소스에 연결하는 동안 프로세스의 모든 처리가 멈추기 때문에 덤프는 신중하게 취할 필요가 있다.  

show full processlist 명령어를 통해 모든 커넥션의 처리 상황을 볼 수 있다.  

### 새로운 기능 추가해 보기  

MySQL에서 정렬해야 할 데이터가 세션 변수 sort_buffer_size에 들어갈 수 있을 경우 메모리 내에서 퀵 정렬을 수행하고, 그렇지 않으면 하나 이상의 중간 파일을 생성하여 머지 정렬을 한다. 하지만 정렬에 limit이 붙은 경우 최상위 N개만 정렬하면 되므로 이에 맞는 정렬 방식은 힙 정렬이다. 만약에 힙 정렬을 MySQL에 추가할 경우 다음 사항을 고려해야 한다.  

- MySQL 소스 코드 어디를 수정해야 할지?
- 어느 조건을 만족시킬때 힙 정렬을 수행하게 할지
- 힙 정렬 처리 구현
- EXPLAIN 출력으로 힙 정렬 발생을 나타내기
- 필요에 따라 유틸리티 함수 구현
- 테스트 케이스 작성  

## 10.6 MySQL 개발 커뮤니티  

### 버그 리포트  

문제, 개요, 재현 순서, 어떻게 수정해야할지에 대해서 게시하면 MySQL 개발자가 내용을 확인하여 해결 방법 검토에 들어간다.  
자체적으로 수정 패치까지 제작해서 같이 보내는 경우도 많다.  

### WorkLog  

신기능 개발 계획을 관리하는 웹 페이지다. 개발 계획을 공개하여 새로운 기능 요청을 받거나(버그 리포트에 하는 경우도 있다.), 설계에 대한 리뷰를 받는다.  
