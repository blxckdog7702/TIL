# SQL 문의 특징과 이를 잘 다루는 법  

## 4.1 테이블 조작하기  

MySQL 기준 데이터베이스를 조작하는데 필요한 여러 프로그램들이 있다.  

- mysqld : 데이터베이스 서버  
- mysql client : 데이터베이스 접근하는데 사용하는 클라이언트 프로그램  
- mysqldump : 백업 도구
- mysqladmin : 관리 도구  

### 테이블 작성하기  

데이터베이스를 이용하려면 데이터를 담고 있는 테이블을 먼저 정의해야한다. 테이블을 정의할 때는 데이터 형식과 제약 조건을 선언해야 한다. 제약 조건으로는 `PRIMARY`, `NOT NULL` 등이 있다.  

`CREATE TABLE` 구문 자체는 어떤 DB를 사용하더라도 거의 동일하게 동작하나, 데이터베이스 간 호환성 확보가 힘들다. 데이터 형식이나 의미 등 세세한 문법에 차이가 있기 때문이다.  

그리고 한번 만든 테이블은 쉽게 바꿀 수 없다. online 스키마 변경을 지원하는 데이터베이스가 많지 않고, 지원한다 하더라도 테이블에 데이터가 많으면 스키마 변경에 시간이 오래 걸린다.  

### CRUD 쿼리를 이용하여 데이터 조작  

#### INSERT 문  

표준 INSERT문 확장으로 여러 레코드를 한 번의 쿼리에서 집어넣을 수 있는 벌크 INSERT 문이 있고, raw 데이터를 추가하는 LOAD 문도 제공하고 있다.  

#### SELECT 문  

쿼리가 인덱스를 사용하도록 작성해야 작업을 고속화 할 수 있다. 인덱스를 사용하지 않으면 테이블 전체를 풀 스캔하게 되는데, 이러면 작업 속도가 매우 오래걸릴 수 있다.  

#### UPDATE 문  

WHERE 절이 없으면 모든 레코드를 갱신하는데, 이 작업은 모든 레코드를 탐색해야하고, 작업 동안 다른 클라이언트가 동일 테이블에 대해 일체의 업데이트 작업을 할 수 없게 된다. (lock)  
레코드가 존재하는지 모를 경우, 존재하지 않으면 INSERT, 존재하면 UPDATE 해주는 기능도 있다. (`REPLACE`, `INSERT ... ON DUPLICATE KEY UPDATE`)  

#### DELETE 문  

UPDATE와 마찬가지로 WHERE 절이 없으면 테이블의 모든 레코드에 대해서 검색을 수행하게 된다. `TRUNCATE TABLE` 을 사용하면 테이블의 데이터를 고속으로 지워준다.  

#### JOIN  

여러 테이블에 걸친 조건을 쿼리할 일이 있을 때, 조인을 사용하면 조금 더 빠르게 작업을 수행할 수도 있다. 가장 효율적인 액세스 경로를 데이터베이스가 자동으로 판단하여 주고, 데이터베이스에 액세스 횟수를 줄일 수 있기 때문이다.  
데이터베이스가 원격 서버에 있는 경우 (대부분의 경우 이 형태로 운영하지만) 원격 액세스는 꽤 무거운 처리이므로 액세스 횟수를 줄이는 것이 성능상 의미가 있다.  

데이터 양이 많아서 여러 서버에 샤딩을 할 경우엔 조인을 사용하기 어렵다. 조인 대상 테이블(데이터)이 반드시 해당 서버에 있을 거라는 보장이 없기 때문이다. 그래서 샤딩을 예상하는 어플리케이션은 테이블 조인을 하지 않도록 개발을 해야한다.  

그래서 원격 서버에 있는 테이블을 로컬 데이터베이스에 있는 것처럼 보여주는 "데이터베이스 링크' 기능을 가진 제품도 존재한다. 하지만 이 역시 보기에만 그렇지, 원격 서버에 접근하기 때문에 네트워크 액세스가 발생한다.  

## 4.2 SQL 문의 실행 효율 의식하기  

### 적절한 인덱스가 사용되고 있는지 확인  

인덱스를 사용하지 못하는 경우, 테이블 전체를 탐색해야하기 때문에 작업이 오래걸릴 수 밖에 없다. 'EXPLAIN'을 사용하면 SQL의 실행 방식이 적절한지 실행 전에 알 수 있다. 또는 쿼리 분석 도구들도 존재한다.  

그리고 데이터에 대한 조작 뿐 아니라 데이터베이스 운영에 관련된 명령도 수행하고 싶은 경우가 생긴다. 다음과 같은 내용도 SQL 문으로 작성할 수 있도록 대부분의 데이터베이스에서 지원하는 경우가 많다.  

- 초당 몇 차례의 쿼리를 실행하고 있는가?
- 초당 몇 개의 레코드를 읽고 있는가?
- 초당 몇 차례의 무거운 쿼리가 실행되고 있는가?

## 4.3 SQL의 장점과 단점  

### SQL은 기술 습득이 용이하다  

학습이 쉽고, 쿼리 문 관리가 용이하다. 하지만 데이터베이스 아키텍처와 인덱스 구조, 디스크와 메모리 속도를 고려해서 쿼리를 짜는 것은 어렵다.  

간단한 로직을 수행하고 싶은 경우 `Stored procedure`를 사용하면 구현할 수 있다. 하지만 유지보수와 작성이 어려운 문제로, 요즘엔 데이터베이스에선 데이터의 출입을 다루는 일만을 수행하고, 로직에 관련된 일은 어플리케이션 단에서 수행하는 경우가 많다.  

예전에는 네트워크 속도가 느려서 데이터베이스를 여러 번 호출하는 것보다, 저장 프로시저를 한 번 수행하는게 더 이득인 경우가 있었으나, 요즘엔 그렇게 하지 않는다. 특정 로직이 매우 높은 빈도로 불리는 경향이 있어서 그런 특수한 처리만 고속으로 수행하기 위해서 저장 프로시저로 최적하는 경우가 있기는 하다.  
